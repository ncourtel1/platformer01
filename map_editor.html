<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tilemap Editor</title>
  <style>
    body {
      display: flex;
      margin: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #editor {
      display: grid;
      grid-template-columns: auto 200px;
      width: 100%;
    }
    canvas {
      border: 1px solid black;
    }
    #map {
      cursor: crosshair;
    }
    #tilemap {
      cursor: pointer;
    }
    #controls {
      padding: 10px;
      background-color: #f8f8f8;
    }
    button, input {
      margin-top: 10px;
      padding: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="editor">
    <canvas id="map" width="512" height="512"></canvas>
    <div id="controls">
      <canvas id="tilemap" width="544" height="166"></canvas>
      <input type="file" id="importFile" accept=".json">
      <input type="text" id="filename" placeholder="map.json">
      <button id="import">Import JSON</button>
      <button id="export">Export JSON</button>
      <pre id="output"></pre>
    </div>
  </div>
  <script>
    const tileSize = 32;
    const mapWidth = 16;
    const mapHeight = 16;

    const mapCanvas = document.getElementById('map');
    const mapCtx = mapCanvas.getContext('2d');
    const tilemapCanvas = document.getElementById('tilemap');
    const tilemapCtx = tilemapCanvas.getContext('2d');
    const importButton = document.getElementById('import');
    const exportButton = document.getElementById('export');
    const importFileInput = document.getElementById('importFile');
    const filenameInput = document.getElementById('filename');
    const output = document.getElementById('output');

    let map = Array.from({ length: mapHeight }, () => Array(mapWidth).fill(-1));
    let tilemapImage = new Image();
    let selectedTile = null;

    tilemapImage.src = 'assets/Palm Tree Island/Sprites/Terrain/tileMap.png';
    tilemapImage.onload = () => {
      tilemapCanvas.width = tilemapImage.width;
      tilemapCanvas.height = tilemapImage.height;
      tilemapCtx.drawImage(tilemapImage, 0, 0);
    };

    function drawGrid() {
      mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
      for (let y = 0; y < mapHeight; y++) {
        for (let x = 0; x < mapWidth; x++) {
          mapCtx.strokeStyle = '#ddd';
          mapCtx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
          if (map[y][x] !== -1) {
            const sx = (map[y][x] % (tilemapImage.width / tileSize)) * tileSize;
            const sy = Math.floor(map[y][x] / (tilemapImage.width / tileSize)) * tileSize;
            mapCtx.drawImage(tilemapImage, sx, sy, tileSize, tileSize, x * tileSize, y * tileSize, tileSize, tileSize);
          }
        }
      }
    }

    tilemapCanvas.addEventListener('click', (e) => {
      const rect = tilemapCanvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / tileSize);
      const y = Math.floor((e.clientY - rect.top) / tileSize);
      selectedTile = y * (tilemapImage.width / tileSize) + x;
    });

    mapCanvas.addEventListener('click', (e) => {
      if (selectedTile === null) return;
      const rect = mapCanvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / tileSize);
      const y = Math.floor((e.clientY - rect.top) / tileSize);
      if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight) {
        map[y][x] = selectedTile;
        drawGrid();
      }
    });

    exportButton.addEventListener('click', () => {
      const json = JSON.stringify(map);
      output.textContent = json;
      const blob = new Blob([json], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filenameInput.value.trim() || "map.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    importButton.addEventListener('click', () => {
      const file = importFileInput.files[0];
      if (!file) {
        alert("SÃ©lectionne un fichier JSON");
        return;
      }

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          if (Array.isArray(data) && data.length === mapHeight && data.every(row => Array.isArray(row) && row.length === mapWidth)) {
            map = data;
            drawGrid();
          } else {
            alert("Fichier JSON invalide");
          }
        } catch (error) {
          alert("Erreur lors du chargement du fichier");
        }
      };
      reader.readAsText(file);
    });

    drawGrid();
  </script>
</body>
</html>
